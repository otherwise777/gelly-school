<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="./favicon.ico">

    <title>Tutorial2</title>

    <!-- Bootstrap core CSS -->
    <link href="./dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="navbar-fixed-top.css" rel="stylesheet">

    <script src="./assets/js/ie-emulation-modes-warning.js"></script>


  </head>

  <body>

 <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="./flink-forward.html">Gellyschool@FF15</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Tutorials<span class="caret"></span></a>
              <ul class="dropdown-menu">
          <li><a href="./ff15-tutorial0.html">Tutorial#0: Graphs 101</a></li>
        <li><a href="./ff15-tutorial1.html">Tutorial#1: Degree Distributions</a></li>
        <li><a href="./ff15-tutorial2.html">Tutorial#2: PageRank on the ReplyGraph</a></li>
        <li><a href="./ff15-tutorial3.html">Tutorial#3: People You Might Know</a></li>
              </ul>
            </li>
            <li><a href="https://github.com/vasia/gelly-school/tree/ff-solutions">Solutions</a></li>
            <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-0.9/libs/gelly_guide.html">Gelly Docs</a></li> 
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <!-- Begin page content -->
    <div class="container">
      <div class="page-header">
        <h1>PageRank on the ReplyGraph</h1>
      </div>
      <h3>How high do I rank, Gelly?</h3>
      <p>In this tutorial, we are going to analyze the structure of the Flink community in more detail, using Gelly's PageRank library algorithm.
      <a href="https://en.wikipedia.org/wiki/PageRank">PageRank</a> is an algorithm that was first used to rank web search engine results. Today, the algorithm and many variations are used in various graph application domains. The idea of PageRank is that <em>important</em> or <em>relevant</em> pages tend to link to other important pages. The algorithm operates in iterations, where pages distribute their scores to their neighbors (pages they have links to) and subsequently update their scores based on the partial values they receive.</p>
      <p>However, not all page links have the same value. In order to consider the importance of a link from one page to another, scores are divided by the total number of out-links of the source page. Thus, a page with 10 links will distribute 1/10 of its score to each neighbor, while a page with 100 links, will distribute 1/100 of its score to each neighboring page. This process computes what is often called the <em>transition probablities</em>, i.e. the probability that some page will lead to other page while surfing the web.</p>
      <p>Taking this idea a bit further, it might be the case that not all neighbors of a page have the same importance. For example, think of a social network. You may have hundreds of Facebook friends, but you interact more with some of them than with others. This <em>degree of interaction</em> is reflected in the Reply Graph data by the number of replies between two e-mail addresses and we are going to exploit it in our PageRank implementation.</p>
      
<h3>The task</h3>
<p>First, read the Reply Graph as an Edge DataSet and use it to generate a Graph, like you did in the previous tutorial. Note that this time, we will use the edge values, so make sure you read all three fields of the input records.
Then, normalize the edge weights to make then reflect the transition probabilities: each vertex calculates the sum of the weights of its out-going edges. Then, each edge weight is divided by the sum of its source vertex to produce the normalized weight. For example, consider vertex A with three out-neighbors, B, C, and D. Let edge A-B have weight 3, and let both edges A-C and A-D have weight 1. The sum of weights for vertex 1 will be 3+1+1=5 and the normalized weights will be 0.6, 0.2, and 0.2 respectively. 
Finally, apply the Gelly PageRank algorithm to the weighted Graph.
<p>Follow the steps below or grab <a href="https://github.com/vasia/gelly-school/blob/ff-skeleton/src/main/java/flink/gelly/school/PageRankWithEdgeWeights.java">the skeleton code</a> from Github to get started!</p>

<h4>Step#1: Create the Graph and initialize the ranks</h4>
<p>When creating the Graph, read the edge values as <em>Double</em> types and initialize the Vertex values to 1.0.</p>
<div style="background: #f8f8f8; overflow:auto;width:auto;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-style: italic">// read the Edge DataSet from the input file</span>
DataSet<span style="color: #666666">&lt;</span>Tuple3<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> String<span style="color: #666666">,</span> Double<span style="color: #666666">&gt;&gt;</span> links <span style="color: #666666">=</span> env<span style="color: #666666">.</span><span style="color: #BB4444">readCsvFile</span><span style="color: #666666">(</span>input<span style="color: #666666">)</span> <span style="color: #666666">...</span>
<span style="color: #008800; font-style: italic">// set the field and line delimiters</span>
<span style="color: #008800; font-style: italic">// set the field types</span>


<span style="color: #008800; font-style: italic">// create a Graph with vertex values initialized to 1.0 (the initial rank)</span>
Graph<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> Double<span style="color: #666666">,</span> Double<span style="color: #666666">&gt;</span> network <span style="color: #666666">=</span> Graph<span style="color: #666666">.</span><span style="color: #BB4444">fromTupleDataSet</span><span style="color: #666666">(</span>links<span style="color: #666666">,</span>
    <span style="color: #AA22FF; font-weight: bold">new</span> MapFunction<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> Double<span style="color: #666666">&gt;()</span> <span style="color: #666666">{</span>
      <span style="color: #666666">...</span>
    <span style="color: #666666">},</span> env<span style="color: #666666">);</span>
</pre></div>

<br>
<h4>Step#2: Calculate the transition probabilities</h4>
<p>We can calculate the transition probabilities in two steps. First, each vertex computes the total weight of its out-edges and then each edge weight is scaled, by diving with its source vertex values. The total edge weight calculation can be realized using a Gelly <a href="https://ci.apache.org/projects/flink/flink-docs-release-0.9/libs/gelly_guide.html#neighborhood-methods">neighborhood method</a>. Neighborhood methods allow users to compute aggrgegations on the neighbors of each vertex in parallel. For this tutorial, all a vertex needs to do it sum up the weights of its out-edges. For the second step, use Gelly's <em>join</em> transformations. <strong>joinWithEdgesOnSource</strong> lets you join a dataset with the edges of your graph, using the edge's source ID as the join key. It receives a map function that lets you update the edge weights, by applying a transformation on current edge weights the dataset record that matches the source Id.</p>

<div style="background: #f8f8f8; overflow:auto;width:auto;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-style: italic">// for each vertex calculate the total weight of its outgoing edges</span>
<span style="color: #008800; font-style: italic">// hint: use the {@link org.apache.flink.graph.Graph#reduceOnEdges} method</span>
DataSet<span style="color: #666666">&lt;</span>Tuple2<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> Double<span style="color: #666666">&gt;&gt;</span> sumEdgeWeights <span style="color: #666666">=</span> <span style="color: #666666">...</span>

<span style="color: #008800; font-style: italic">// assign the transition probabilities as edge weights:</span>
<span style="color: #008800; font-style: italic">// divide edge weight by the total weight of outgoing edges for that source</span>
<span style="color: #008800; font-style: italic">// hint: use the {@link org.apache.flink.graph.Graph#joinWithEdgesOnSource} method</span>
Graph<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> Double<span style="color: #666666">,</span> Double<span style="color: #666666">&gt;</span> networkWithWeights <span style="color: #666666">=</span> <span style="color: #666666">...</span>

<span style="color: #008800; font-style: italic">// This neighborhood function calculates the total weight of outgoing edges for a vertex</span>
<span style="color: #AA22FF; font-weight: bold">static</span> <span style="color: #AA22FF; font-weight: bold">final</span> <span style="color: #AA22FF; font-weight: bold">class</span> <span style="color: #0000FF">SumWeight</span> <span style="color: #AA22FF; font-weight: bold">implements</span> ReduceEdgesFunction<span style="color: #666666">&lt;</span>Double<span style="color: #666666">&gt;</span> <span style="color: #666666">{</span>
  
  <span style="color: #AA22FF">@Override</span>
  <span style="color: #AA22FF; font-weight: bold">public</span> Double <span style="color: #00A000">reduceEdges</span><span style="color: #666666">(</span>Double firstEdgeValue<span style="color: #666666">,</span> Double secondEdgeValue<span style="color: #666666">)</span> <span style="color: #666666">{</span>
    <span style="color: #666666">...</span>
  <span style="color: #666666">}</span>
<span style="color: #666666">}</span>
</pre></div>

<br><h4>Step #3: Run PageRank</h4>
<p>Once you have computed the weighted Reply Graph with the appropriate transition probabilities, you can easily run Gelly's PageRank algorithm by calling Graph's <strong>run()</strong> method. The algorithm receives two parameters. The first one is the <em>dampening factor</em>. It defines the probability that a surfer who is randomly following links will continue surfing. This constant is generally set to 0.85. The second parameter defines the number of iteration steps to execute. For our dataset, you can set this parameter to 10 iterations.</p>

<div style="background: #f8f8f8; overflow:auto;width:auto;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-style: italic">// run the Page Rank algorithm on the weighted graph</span>
DataSet<span style="color: #666666">&lt;</span>Vertex<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> Double<span style="color: #666666">&gt;&gt;</span> pageRanks <span style="color: #666666">=</span> networkWithWeights<span style="color: #666666">.</span><span style="color: #BB4444">run</span><span style="color: #666666">(</span>
    <span style="color: #AA22FF; font-weight: bold">new</span> PageRankAlgorithm<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;(...))...</span>

<span style="color: #008800; font-style: italic">// write the output and execute the program</span>
pageRanks<span style="color: #666666">.</span><span style="color: #BB4444">writeAsCsv</span><span style="color: #666666">(...);</span>
env<span style="color: #666666">.</span><span style="color: #BB4444">execute</span><span style="color: #666666">();</span>
</pre></div>


<br><h4>Piece of cake!</h4>
<p>If you've made it so far and you've filled in the gaps, open the output files and inspect the results!

<p><h4><a style="margin-left: 100px" href="./ff15-tutorial1.html"><em><--Previous</em></a> <a style="margin-left: 650px" href="./ff15-tutorial3.html"><em>Next--></em></a></h4></p>
<br><br>
</div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="./dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="./assets/js/ie10-viewport-bug-workaround.js"></script>
  </body>
</html>
