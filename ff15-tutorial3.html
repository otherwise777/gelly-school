<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="./favicon.ico">

    <title>Tutorial3</title>

    <!-- Bootstrap core CSS -->
    <link href="./dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="navbar-fixed-top.css" rel="stylesheet">

    <script src="./assets/js/ie-emulation-modes-warning.js"></script>


  </head>

  <body>

   <!-- Fixed navbar -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="./flink-forward.html">Gellyschool@FF15</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Tutorials<span class="caret"></span></a>
              <ul class="dropdown-menu">
          <li><a href="./ff15-tutorial0.html">Tutorial#0: Graphs 101</a></li>
        <li><a href="./ff15-tutorial1.html">Tutorial#1: Degree Distributions</a></li>
        <li><a href="./ff15-tutorial2.html">Tutorial#2: PageRank on the ReplyGraph</a></li>
        <li><a href="./ff15-tutorial3.html">Tutorial#3: People You Might Know</a></li>
              </ul>
            </li>
            <li><a href="https://github.com/vasia/gelly-school/tree/ff-solutions">Solutions</a></li>
            <li><a href="https://ci.apache.org/projects/flink/flink-docs-release-0.9/libs/gelly_guide.html">Gelly Docs</a></li> 
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
    
<!-- Begin page content -->
    <div class="container">
      <div class="page-header">
        <h1>People you Might Know</h1>
      </div>
      <h3>Have we met before, Gelly?</h3>
      <p>In social networks, we are often shown a list of users we might know or we might want to connect to. For this last exercise, we will implement a simple application of this concept. For each user, we are going to create a list of neighbors' neighbors, who are not already in the user's friends list. Then, we are going to recommend people who appear in this list at least as many times as a user-defined threshold. The idea is that if you are friends with Alice, and Alice is friends with Bob, then there is a chance you might also know Bob. The more friends you have that are friends with Bob, the higher the chance you also know him (or might like to know him).</p>

      <h3>Neighborhood Methods</h3>
      <p>In order to complete this exercise, we need to talk a little bit more about Gelly's <em>neighborhood methods</em>. We already saw one of them in <a href="./ff15-tutorial2.html">Tutorial#2</a> and used it to calculate the sum of the values of the edges for each vertex. Here, we explain in more detail how these methods work.</p>
      <p>Neighborhood methods allow vertices to perform an aggregation on their first-hop neighborhood. <strong>reduceOnEdges</strong> can be used to compute an aggregation on the values of the neighboring edges of a vertex and <strong>reduceOnNeighbors</strong> can be used to compute an aggregation on the values of the neighboring vertices. These methods assume associative and commutative aggregations (like sum, min, and max) and exploit combiners internally, significantly improving performance. The neighborhood scope is defined by the <strong>EdgeDirection</strong> parameter, which takes the values <b>IN</b>, <b>OUT</b> or <b>ALL</b>. IN will gather all in-coming edges (neighbors) of a vertex, OUT will gather all out-going edges (neighbors), while ALL will gather all edges (neighbors).
      For example, assume that you want to select the minimum ID of all in-neighbors for each vertex in the following graph:</p>
      <p><img src="./images/ff15-tut3-neighborhood.png" hspace="20"/></p>
      <p>Vertices 2, 3, and 5 each have one in-neighbor, while 4 has four in-neighbors. Aggregations are applied on pairs of values and then get  combined, until a single value is produced:</p>
      <p><img src="./images/ff15-tut3-reduceOnNeighbors.png" hspace="20"/></p>

      <p>Sometimes, we want to compute more complex aggregations that a simple minimum, for which we might need to access all neighboring values of a vertex together. Gelly has special neighborhood methods for such cases, namely <b>groupReduceonEdges</b> and <b>groupReduceOnNeighbors</b>. With these methods, we also have the flexibility to return zero, one or more values per vertex.</p>
      <b>groupReduceonEdges</b> creates one group per vertex, where you can access the edges (of the specified <b>EdgeDirection</b>) and their values (if the graph is weighted).
      These are the groups for the example graph above and EdgeDirection.OUT:
      <p><img src="./images/ff15-tut3-groupReduceOnEdges.png" hspace="10"/></p>
      <b>groupReduceOnNeighbors</b> creates one group per vertex, where, apart from the edges, you can also access the neighboring vertices, including their values.
      These are the groups for the example graph above and EdgeDirection.IN:
      <p><img src="./images/ff15-tut3-groupReduceOnNeighbors.png" hspace="20"/></p>
      

      <h3>The task</h3>
      <p>Start by creating a Graph from the edges input, like in the previous tutorials, wihout reading the edge weights. Then, use a neighborhood method to gather the IDs of all neighbors of a vertex inside a HashSet. Update the vertex values to this neighborhood HashSet, using a Gelly join method. Finally, use another neighborhood method to compare each node's neighborhood with the one of its neighbors, to find vertices that they don't have in common (candidates for recommendation). Use a HashMap to count how many times you come across a candidate vertex. Finally, output the Ids of friends-of-friends that you came across at least as many times as aspecified threshold value.<br>Follow the steps below or grab the <a href="https://github.com/vasia/gelly-school/blob/ff-skeleton/src/main/java/flink/gelly/school/PeopleYouMightKnow.java">skeleton code</a> from Github to get started!</p><br>

      <h4>Step#1: Create the Graph and initialize the vertex values</h4>
<div style="background: #f8f8f8; overflow:auto;width:auto;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-style: italic">// Read the input file of edges with String Ids</span>
<span style="color: #008800; font-style: italic">// Hint: use includeFields() to only read the first 2 columns of the input</span>
<span style="color: #008800; font-style: italic">// and a mapper to create Edges with values of type NullValue</span>
DataSet<span style="color: #666666">&lt;</span>Edge<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> NullValue<span style="color: #666666">&gt;&gt;</span> edges <span style="color: #666666">=</span> env<span style="color: #666666">.</span><span style="color: #BB4444">readCsvFile</span><span style="color: #666666">(</span>input<span style="color: #666666">)</span>
    <span style="color: #666666">...</span>
    <span style="color: #666666">.</span><span style="color: #BB4444">map</span><span style="color: #666666">(</span><span style="color: #AA22FF; font-weight: bold">new</span> MapFunction<span style="color: #666666">&lt;</span>Tuple2<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> String<span style="color: #666666">&gt;,</span> Edge<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> NullValue<span style="color: #666666">&gt;&gt;()</span> <span style="color: #666666">{</span>
          <span style="color: #666666">...</span>
    <span style="color: #666666">});</span>

<span style="color: #008800; font-style: italic">// Create a Graph from the input edges</span>
<span style="color: #008800; font-style: italic">// and initialize the vertices with a HashSet</span>
<span style="color: #008800; font-style: italic">// whose only element is the vertex ID itself</span>
Graph<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> HashSet<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;,</span> NullValue<span style="color: #666666">&gt;</span> graph <span style="color: #666666">=</span> Graph<span style="color: #666666">.</span><span style="color: #BB4444">fromDataSet</span><span style="color: #666666">(</span>edges<span style="color: #666666">,</span>
    <span style="color: #AA22FF; font-weight: bold">new</span> MapFunction<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> HashSet<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;&gt;()</span> <span style="color: #666666">{</span>

        <span style="color: #AA22FF; font-weight: bold">public</span> HashSet<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;</span> <span style="color: #00A000">map</span><span style="color: #666666">(</span>String id<span style="color: #666666">)</span> <span style="color: #666666">{</span>

      <span style="color: #666666">...</span>
    <span style="color: #666666">}</span>
  <span style="color: #666666">},</span> env<span style="color: #666666">);</span>
</pre></div>

<br>
<h4>Step#2: Fill in the HashSet of each vertex with its neighbors' IDs</h4>
<p>Use <b>reduceOnNeighbors</b> to create a HashSet of all the neighbors for each vertex. Then, attach the computed HashSets as vertex values to the original graph:</p>
<div style="background: #f8f8f8; overflow:auto;width:auto;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-style: italic">// Fill in the HashSet of each vertex with its neighbors&#39; IDs</span>
<span style="color: #008800; font-style: italic">// Hint: use the {@link org.apache.flink.graph.Graph#reduceOnNeighbors} method</span>
<span style="color: #008800; font-style: italic">// and set the EdgeDirection to ALL</span>
DataSet<span style="color: #666666">&lt;</span>Tuple2<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> HashSet<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;&gt;&gt;</span> verticesWithNeighbors <span style="color: #666666">=</span> <span style="color: #666666">...</span>
    
<span style="color: #008800; font-style: italic">// Attach the neighbor values to the vertices of the graph</span>
<span style="color: #008800; font-style: italic">// Hint: Use the {@link org.apache.flink.graph.Graph#joinWithVertices} method</span>
Graph<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> HashSet<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;,</span> NullValue<span style="color: #666666">&gt;</span> graphWithNeighbors <span style="color: #666666">=</span> <span style="color: #666666">...</span>
</pre></div>

<br>
<h4>Step#3: Compute the "People you Might Know" list</h4>

<div style="background: #f8f8f8; overflow:auto;width:auto;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008800; font-style: italic">// Compute the &quot;people you might know list&quot;</span>
DataSet<span style="color: #666666">&lt;</span>Tuple2<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> String<span style="color: #666666">&gt;&gt;</span> verticesWithList <span style="color: #666666">=</span>
      graphWithNeighbors<span style="color: #666666">.</span><span style="color: #BB4444">groupReduceOnNeighbors</span><span style="color: #666666">(</span>
          <span style="color: #AA22FF; font-weight: bold">new</span> NeighborsFunctionWithVertexValue<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> HashSet<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;,</span> NullValue<span style="color: #666666">,</span> Tuple2<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> String<span style="color: #666666">&gt;&gt;()</span> <span style="color: #666666">{</span>
            
            <span style="color: #AA22FF; font-weight: bold">public</span> <span style="color: #00BB00; font-weight: bold">void</span> <span style="color: #00A000">iterateNeighbors</span><span style="color: #666666">(</span>Vertex<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> HashSet<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;&gt;</span> vertex<span style="color: #666666">,</span>
              Iterable<span style="color: #666666">&lt;</span>Tuple2<span style="color: #666666">&lt;</span>Edge<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> NullValue<span style="color: #666666">&gt;,</span> Vertex<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> HashSet<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;&gt;&gt;&gt;</span> neighbors<span style="color: #666666">,</span>
              Collector<span style="color: #666666">&lt;</span>Tuple2<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> String<span style="color: #666666">&gt;&gt;</span> out<span style="color: #666666">)</span> <span style="color: #666666">{</span>
          
              HashMap<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> Integer<span style="color: #666666">&gt;</span> recommendations <span style="color: #666666">=</span> <span style="color: #AA22FF; font-weight: bold">new</span> HashMap<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> Integer<span style="color: #666666">&gt;();</span>
              
              <span style="color: #AA22FF; font-weight: bold">for</span> <span style="color: #666666">(</span>Tuple2<span style="color: #666666">&lt;</span>Edge<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> NullValue<span style="color: #666666">&gt;,</span> Vertex<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> HashSet<span style="color: #666666">&lt;</span>String<span style="color: #666666">&gt;&gt;&gt;</span> <span style="color: #A0A000">t:</span> neighbors<span style="color: #666666">)</span> <span style="color: #666666">{</span>

              <span style="color: #008800; font-style: italic">// for every friend in the neighbors&#39; friend list</span>
              <span style="color: #AA22FF; font-weight: bold">for</span> <span style="color: #666666">(</span>String <span style="color: #A0A000">friendOfFriend:</span> t<span style="color: #666666">.</span><span style="color: #BB4444">f1</span><span style="color: #666666">.</span><span style="color: #BB4444">getValue</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
              <span style="color: #008800; font-style: italic">// exclude the vertex itself</span>
              <span style="color: #008800; font-style: italic">// if new candidate is found, add the ID to the HashSet with score 1</span>
              <span style="color: #008800; font-style: italic">// if an existing friend is found, increase its score </span>
              <span style="color: #666666">...</span>
              <span style="color: #666666">}</span>
            <span style="color: #666666">}</span>
          
            <span style="color: #008800; font-style: italic">// only output friends-of-friends that appeared at least &lt;threshold&gt; times</span>
            <span style="color: #AA22FF; font-weight: bold">for</span> <span style="color: #666666">(</span>Entry<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> Integer<span style="color: #666666">&gt;</span> <span style="color: #A0A000">friend:</span> recommendations<span style="color: #666666">.</span><span style="color: #BB4444">entrySet</span><span style="color: #666666">())</span> <span style="color: #666666">{</span>
              <span style="color: #AA22FF; font-weight: bold">if</span> <span style="color: #666666">(...)</span> <span style="color: #666666">{</span>
                out<span style="color: #666666">.</span><span style="color: #BB4444">collect</span><span style="color: #666666">(</span><span style="color: #AA22FF; font-weight: bold">new</span> Tuple2<span style="color: #666666">&lt;</span>String<span style="color: #666666">,</span> String<span style="color: #666666">&gt;(</span>vertex<span style="color: #666666">.</span><span style="color: #BB4444">getId</span><span style="color: #666666">(),</span> friend<span style="color: #666666">.</span><span style="color: #BB4444">getKey</span><span style="color: #666666">()));</span>  
              <span style="color: #666666">}</span>
            <span style="color: #666666">}</span>
          <span style="color: #666666">}</span>
    <span style="color: #666666">},</span> EdgeDirection<span style="color: #666666">.</span><span style="color: #BB4444">ALL</span><span style="color: #666666">);</span>
</pre></div>

<br>
<h4>That's all!</h4>
<p>Go ahead and inspect the results. You should see pairs of e-mail addresses where the second one is a recommended friend for the first one.</p>
<p>If you liked Gelly and you want to know more, keep an eye on the <a href="./index.html">Gellyschool website</a>. We'll be updating it soon with more tutorials, covering iterations and other Gelly features. <br>Hope you enjoyed your time at Gellyschool!</p>

	<p><h4><a style="margin-left: 100px" href="./ff15-tutorial2.html"><em><--Previous</em></a></h4></p>
	<br><br>
    </div> <!-- /container -->


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="./dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="./assets/js/ie10-viewport-bug-workaround.js"></script>
  </body>
</html>
